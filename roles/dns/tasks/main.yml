---
- name: Install bind packages
  command: dnf -y install bind bind-utils firewalld
  changed_when: false

- name: Enable and start firewalld
  command: systemctl enable --now firewalld

- name: Open DNS service (permanent)
  command: firewall-cmd --permanent --add-service=dns
  register: r_dns
  failed_when: false
  changed_when: "'success' in (r_dns.stdout | lower)"

- name: Reload firewalld
  command: firewall-cmd --reload

- name: Deploy named.conf
  template:
    src: named.conf.j2
    dest: /etc/named.conf
    owner: root
    group: root
    mode: "0644"

- name: Create zone files from dns_zones
  template:
    src: zone.j2
    dest: "/var/named/{{ item.zone }}.zone"
    owner: root
    group: named
    mode: "0644"
  loop: "{{ dns_zones }}"
  vars:
    zone_name: "{{ item.zone }}"
    records: "{{ item.records | default([]) }}"
    dns_ip: "10.2.1.3"
    serial: "{{ lookup('pipe', 'date +%Y%m%d') }}01"

- name: Restore SELinux context for zone files
  command: restorecon -Rv /var/named
  changed_when: false
  failed_when: false

- name: Validate named.conf
  command: named-checkconf /etc/named.conf

- name: Validate zone files
  command: "named-checkzone {{ item.zone }} /var/named/{{ item.zone }}.zone"
  loop: "{{ dns_zones }}"

- name: Enable and start named
  command: systemctl enable --now named

- name: Restart named to apply changes
  command: systemctl restart named

